# OAuth2 & 2FA Integration Guide

## Overview

This guide covers the integration of OAuth2 (Google & GitHub) and Two-Factor Authentication (TOTP) into the ToolBox SaaS platform. Both features are now fully implemented in backend and frontend with comprehensive error handling, security measures, and user experience optimizations.

## Table of Contents

1. [OAuth2 Integration](#oauth2-integration)
2. [Two-Factor Authentication (2FA)](#two-factor-authentication)
3. [Authentication Flow](#authentication-flow)
4. [Security Considerations](#security-considerations)
5. [Environment Configuration](#environment-configuration)
6. [Testing](#testing)
7. [Troubleshooting](#troubleshooting)

---

## OAuth2 Integration

### Overview

OAuth2 allows users to log in using their Google or GitHub accounts, reducing friction in the onboarding process and providing a familiar authentication method.

### Backend Setup

#### Services

**File:** `backend/src/services/oauthService.ts`

Provides core OAuth functionality:

```typescript
// Verify Google OAuth token
verifyGoogleToken(token: string): Promise<OAuthProfile>

// Exchange GitHub code for user data
verifyGithubCode(code: string): Promise<OAuthProfile>

// Auto-create or retrieve user from OAuth profile
findOrCreateUser(profile: OAuthProfile): Promise<User>

// Link OAuth account to existing user
linkOAuthAccount(userId: string, profile: OAuthProfile): Promise<void>

// Unlink OAuth account (with safety checks)
unlinkOAuthAccount(userId: string, provider: string): Promise<void>

// Get user's connected OAuth accounts
getLinkedAccounts(userId: string): Promise<string[]>

// Generate OAuth authorization URLs
generateGoogleAuthUrl(state: string): string
generateGithubAuthUrl(state: string): string
```

#### Routes

**File:** `backend/src/routes/oauthRoutes.ts`

Endpoints:

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/oauth/google/auth` | Generate Google login URL |
| POST | `/oauth/google/callback` | Handle Google OAuth callback |
| GET | `/oauth/github/auth` | Generate GitHub login URL |
| POST | `/oauth/github/callback` | Handle GitHub OAuth callback |
| POST | `/oauth/link` | Link OAuth account to authenticated user |
| GET | `/oauth/accounts` | List user's linked OAuth accounts (protected) |
| DELETE | `/oauth/:provider` | Unlink OAuth account (protected) |

### Frontend Implementation

**File:** `frontend/src/pages/OAuthPage.tsx`

Features:

- **Login Section**: Direct OAuth login with Google and GitHub buttons
- **Account Linking**: Link/unlink OAuth providers for authenticated users
- **Status Display**: Shows which OAuth providers are linked
- **Error Handling**: User-friendly error messages for failed OAuth operations

### Environment Variables

**Backend** (`.env`):

```bash
# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_REDIRECT_URI=http://localhost:3001/api/oauth/google/callback

# GitHub OAuth
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
GITHUB_REDIRECT_URI=http://localhost:3001/api/oauth/github/callback

# Session (for state parameter)
SESSION_SECRET=your_session_secret
```

### OAuth Flow - User Login

```
1. User clicks "Sign in with Google/GitHub"
   ↓
2. Frontend calls GET /oauth/google/auth or /oauth/github/auth
   ↓
3. Backend generates auth URL with state parameter (CSRF protection)
   ↓
4. Frontend redirects user to OAuth provider (Google/GitHub)
   ↓
5. User authenticates with OAuth provider
   ↓
6. OAuth provider redirects back with authorization code
   ↓
7. Frontend calls POST /oauth/google/callback or /oauth/github/callback
   ↓
8. Backend exchanges code for user info
   ↓
9. Backend finds or creates user from OAuth profile
   ↓
10. Backend returns JWT tokens
    ↓
11. Frontend stores tokens and redirects to account page
```

### OAuth Flow - Account Linking

```
1. Authenticated user clicks "Link Google/GitHub"
   ↓
2. Frontend calls GET /oauth/google/auth or /oauth/github/auth
   ↓
3. Frontend stores linking intent in sessionStorage
   ↓
4. Backend generates auth URL
   ↓
5. User authenticates with OAuth provider
   ↓
6. OAuth provider redirects back with code
   ↓
7. Frontend calls POST /oauth/link with OAuth code
   ↓
8. Backend links OAuth account to authenticated user
   ↓
9. Frontend updates linked accounts list
```

---

## Two-Factor Authentication

### Overview

2FA adds an extra layer of security by requiring users to verify their identity using a Time-based One-Time Password (TOTP) generated by an authenticator app (Google Authenticator, Authy, Microsoft Authenticator, etc.).

### Backend Setup

#### Services

**File:** `backend/src/services/twoFactorService.ts`

Provides 2FA functionality:

```typescript
// Generate TOTP secret, QR code, and backup codes
generateSecret(userId: string, email: string): Promise<TwoFactorSetup>

// Enable 2FA for user (stores secret and hashed backup codes)
enableTwoFactor(userId: string, secret: string, backupCodes: string[]): Promise<void>

// Verify TOTP token during login (30-second window tolerance)
verifyToken(userId: string, token: string): Promise<boolean>

// Verify backup code (removes from list on use)
verifyBackupCode(userId: string, code: string): Promise<boolean>

// Disable 2FA completely
disableTwoFactor(userId: string): Promise<void>

// Generate new set of 10 backup codes
regenerateBackupCodes(userId: string): Promise<string[]>

// Get 2FA status and remaining backup codes
getTwoFactorStatus(userId: string): Promise<TwoFactorStatus>
```

#### Routes

**File:** `backend/src/routes/twoFactorRoutes.ts`

Endpoints:

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/2fa/setup` | Generate QR code and backup codes |
| POST | `/2fa/enable` | Enable 2FA with TOTP verification |
| POST | `/2fa/verify` | Verify TOTP token during login |
| POST | `/2fa/backup-code` | Use backup code as alternative |
| POST | `/2fa/disable` | Disable 2FA (requires password) |
| POST | `/2fa/regenerate-backup-codes` | Generate new backup codes |
| GET | `/2fa/status` | Get 2FA status |

### Frontend Implementation

**File:** `frontend/src/pages/TwoFactorPage.tsx`

Features:

- **Setup Phase**: Display QR code and secret for manual entry
- **Verification Phase**: User enters 6-digit code from authenticator app
- **Backup Codes Phase**: Display and allow download of 10 backup codes
- **Management**: View 2FA status, regenerate codes, disable 2FA
- **Warnings**: Alert when backup codes running low
- **Download**: Save backup codes as text file for safe storage

### Environment Variables

**Backend** (`.env`):

```bash
# 2FA (uses speakeasy library, no external config needed)
TOTP_WINDOW_SIZE=2  # Allow 30-second window tolerance (default: 2)
```

### 2FA Setup Flow

```
1. User clicks "Setup 2FA"
   ↓
2. Frontend calls GET /2fa/setup
   ↓
3. Backend generates:
   - TOTP secret
   - QR code (data URL)
   - 10 backup codes
   ↓
4. Frontend displays QR code and secret
   ↓
5. User scans QR with authenticator app OR enters secret manually
   ↓
6. Authenticator app generates 6-digit code
   ↓
7. User enters code and clicks "Verify Code"
   ↓
8. Frontend calls POST /2fa/enable with secret, backup codes, token
   ↓
9. Backend verifies token matches secret
   ↓
10. Backend enables 2FA (stores secret and hashed backup codes)
    ↓
11. Frontend displays backup codes
    ↓
12. User downloads/saves backup codes
    ↓
13. Setup complete, 2FA now active
```

### 2FA Login Flow

```
1. User enters credentials (email/password or OAuth)
   ↓
2. Backend verifies credentials
   ↓
3. Backend checks if user has 2FA enabled
   ↓
4. If 2FA enabled, return 401 with "2FA required" message
   ↓
5. Frontend shows 2FA verification UI
   ↓
6. User enters 6-digit code from authenticator app
   ↓
7. Frontend calls POST /2fa/verify with token
   ↓
8. Backend verifies token against user's TOTP secret
   ↓
9. If valid, return JWT tokens
   ↓
10. If invalid, allow retry (show error)
    ↓
11. User can also enter backup code if device lost
    ↓
12. Frontend stores tokens and logs user in
```

---

## Authentication Flow

### Complete Login Flow with OAuth & 2FA

```
┌─────────────────────────────────────────────────────────────────┐
│                      LOGIN START                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴──────────┐
                    │                    │
            ┌───────▼────────┐   ┌───────▼────────┐
            │ Standard Login │   │  OAuth Login   │
            │ (Email/Pwd)    │   │  (Google/GH)   │
            └────────┬───────┘   └────────┬────────┘
                     │                    │
                ┌────┴────────────────────┴────┐
                │                               │
            ┌───▼──────────────┐    ┌───────────▼────┐
            │ Verify Password  │    │ Exchange Code  │
            │ or OAuth Token   │    │ for User Info  │
            └────┬─────────────┘    └───────┬────────┘
                 │                          │
                 └──────────┬────────────────┘
                            │
                    ┌───────▼───────────┐
                    │ User has 2FA?     │
                    └──┬────────────┬───┘
                    NO │            │ YES
                       │     ┌──────▼────────┐
                       │     │ Request 2FA   │
                       │     │ Verification  │
                       │     │ (6-digit code │
                       │     │  or backup)   │
                       │     └──────┬────────┘
                       │            │
                       │    ┌───────▼──────────┐
                       │    │ Verify TOTP or   │
                       │    │ Backup Code      │
                       │    └───────┬──────────┘
                       │            │
                       └────┬───────┘
                            │
                    ┌───────▼──────────┐
                    │ Return JWT Tokens │
                    │ + Refresh Token   │
                    └───────┬──────────┘
                            │
                    ┌───────▼──────────┐
                    │ LOGIN COMPLETE   │
                    └──────────────────┘
```

---

## Security Considerations

### OAuth2 Security

1. **State Parameter**: CSRF protection using state parameter in OAuth flow
   - State stored in session/sessionStorage
   - Validated on callback

2. **Token Validation**: 
   - Google tokens verified using google-auth-library
   - GitHub tokens verified by exchanging code through secure channel

3. **Account Linking Prevention**:
   - System prevents same email being linked to multiple accounts
   - Duplicate linking prevented with validation check

4. **Account Lockout Prevention**:
   - Users with OAuth account can unlink only if password is set
   - This prevents lockout if losing access to OAuth provider

### 2FA Security

1. **TOTP Standard**: RFC 6238 compliant time-based one-time passwords
   - 30-second time window
   - 6-digit codes
   - Uses HMAC-SHA1

2. **Backup Codes**:
   - 10 one-time use codes generated during setup
   - Hashed with bcrypt before storage (never stored in plaintext)
   - Each code can only be used once
   - Used as account recovery mechanism

3. **Time Window Tolerance**: 
   - Accepts tokens within ±30 seconds (compensates for clock skew)
   - Prevents legitimate users from being locked out due to minor time differences

4. **Password Verification**:
   - Disabling 2FA requires password verification
   - Regenerating backup codes requires password verification
   - Prevents unauthorized account modifications

5. **No Recovery Code Reuse**:
   - Each backup code automatically removed after use
   - Attempting to reuse returns error

### General Security Best Practices

1. **HTTPS Only**: 
   - OAuth and 2FA must only work over HTTPS in production
   - Set `secure` flag on cookies

2. **Audit Logging**: 
   - All OAuth/2FA events logged for security audit trail
   - Login attempts, code failures, account linking/unlinking recorded

3. **Rate Limiting**: 
   - 2FA verification attempts rate limited
   - Prevents brute-force attacks on 6-digit codes

4. **Secrets Never Exposed**:
   - TOTP secrets never logged or sent to client after setup
   - QR codes displayed only once during setup

---

## Environment Configuration

### Backend .env

```bash
# =================================================================
# OAUTH2 CONFIGURATION
# =================================================================

# Google OAuth
# Get from: https://console.cloud.google.com/
GOOGLE_CLIENT_ID=your_google_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_REDIRECT_URI=http://localhost:3001/api/oauth/google/callback

# GitHub OAuth
# Get from: https://github.com/settings/developers
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
GITHUB_REDIRECT_URI=http://localhost:3001/api/oauth/github/callback

# Session (for state parameter in OAuth)
SESSION_SECRET=your_random_session_secret_min_32_chars

# =================================================================
# 2FA CONFIGURATION
# =================================================================

# TOTP settings (time-based one-time password)
TOTP_ISSUER=ToolBox              # App name shown in authenticator
TOTP_WINDOW_SIZE=2               # Allow ±30sec window (2 * 30sec)

# =================================================================
# SECURITY
# =================================================================

# Backup code settings
BACKUP_CODE_LENGTH=10            # Number of backup codes
BACKUP_CODE_FORMAT=8             # Length of each code (e.g., XXXX-XXXX)
```

### Frontend .env

```bash
# No additional frontend OAuth/2FA env vars needed
# All configuration handled by backend
```

### Google OAuth Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create new project or select existing one
3. Enable "Google+ API"
4. Go to "Credentials" → "Create Credentials" → "OAuth 2.0 Client IDs"
5. Select "Web application"
6. Add authorized redirect URIs:
   - `http://localhost:3001/api/oauth/google/callback` (dev)
   - `https://yourdomain.com/api/oauth/google/callback` (prod)
7. Copy Client ID and Client Secret to .env

### GitHub OAuth Setup

1. Go to [GitHub Settings → Developer settings](https://github.com/settings/developers)
2. Click "New OAuth App"
3. Fill in:
   - Application name: ToolBox
   - Homepage URL: http://localhost:3000 (dev) or https://yourdomain.com (prod)
   - Authorization callback URL: http://localhost:3001/api/oauth/google/callback (dev)
4. Copy Client ID and Client Secret to .env

---

## Testing

### Backend Tests

**OAuth Service Tests** (`backend/src/__tests__/services/oauthService.test.ts`):

```bash
npm test -- oauthService
```

Tests cover:
- Google token verification
- GitHub code exchange
- User auto-creation from OAuth profiles
- Account linking/unlinking
- Duplicate linking prevention
- Safety checks for unlinking

**OAuth Routes Tests** (`backend/src/__tests__/routes/oauthRoutes.test.ts`):

```bash
npm test -- oauthRoutes
```

Tests cover:
- OAuth URL generation with CSRF state
- OAuth callback handling
- Token validation and error handling
- User creation and account linking flows

### Frontend Tests

**TwoFactorPage Tests** (`frontend/src/__tests__/pages/TwoFactorPage.test.tsx`):

```bash
npm run test -- TwoFactorPage
```

Tests cover:
- Initial setup phase
- QR code display
- Code verification
- Backup code display and download
- 2FA disabling with password
- Backup code regeneration
- Error handling and user feedback

**OAuthPage Tests** (`frontend/src/__tests__/pages/OAuthPage.test.tsx`):

```bash
npm run test -- OAuthPage
```

Tests cover:
- OAuth URL generation
- Social login buttons
- Account linking/unlinking UI
- Error handling
- Status display

### Manual Testing Checklist

#### OAuth Testing

- [ ] Test Google login flow (create new account)
- [ ] Test Google login flow (existing account)
- [ ] Test GitHub login flow (create new account)
- [ ] Test GitHub login flow (existing account)
- [ ] Test linking Google to existing user
- [ ] Test linking GitHub to existing user
- [ ] Test unlinking OAuth accounts
- [ ] Test unlinking prevents account lockout (requires password)
- [ ] Verify state parameter prevents CSRF
- [ ] Verify JWT tokens returned correctly

#### 2FA Testing

- [ ] Test 2FA setup flow with Google Authenticator
- [ ] Test 2FA setup flow with Authy
- [ ] Test 2FA setup flow with Microsoft Authenticator
- [ ] Test entering 6-digit code during setup
- [ ] Test incorrect code error handling
- [ ] Test backup code display and download
- [ ] Test login flow with 2FA (correct code)
- [ ] Test login flow with 2FA (incorrect code)
- [ ] Test login flow with backup code
- [ ] Test backup code cannot be reused
- [ ] Test 2FA disable requires password
- [ ] Test regenerate backup codes requires password
- [ ] Test warning when backup codes running low

---

## Troubleshooting

### OAuth Issues

#### "Invalid state parameter" error

**Cause**: State mismatch between request and callback

**Solution**: 
- Verify SESSION_SECRET is set correctly
- Check browser allows cookies
- Clear browser cache/cookies and retry

#### "Invalid code" error

**Cause**: Authorization code expired or already used

**Solution**:
- OAuth codes typically expire in 10 minutes
- User must retry OAuth flow
- Check OAuth provider rate limits

#### Google OAuth not working

**Cause**: Client ID/secret incorrect or redirect URI mismatch

**Solution**:
- Verify GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET in .env
- Check GOOGLE_REDIRECT_URI matches exactly in Google Cloud Console
- Ensure Google+ API is enabled in Google Cloud
- Check for typos in environment variables

#### GitHub OAuth not working

**Cause**: Client ID/secret incorrect or redirect URI mismatch

**Solution**:
- Verify GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET in .env
- Check GITHUB_REDIRECT_URI matches exactly in GitHub settings
- Ensure OAuth app is set to public (not draft)
- Verify GitHub account has permission to create OAuth apps

#### "Cannot link account" error

**Cause**: Email already linked to another account

**Solution**:
- User must unlink from other account first
- Or use different OAuth provider
- Contact support if unsure

### 2FA Issues

#### "Invalid verification code" error

**Cause**: 
- Incorrect code entered
- Time skew between server and authenticator app
- Using expired code (codes valid for ~30 seconds)

**Solution**:
- Have user verify time on phone/computer is correct
- Try entering next code (wait 30 seconds)
- Use backup code if code fails multiple times
- Regenerate backup codes if all used

#### "No backup codes remaining" error

**Cause**: All 10 backup codes have been used

**Solution**:
- User must regenerate backup codes (requires password)
- Or disable/re-enable 2FA to get new codes
- Encourage user to save backup codes securely

#### QR code not scanning

**Cause**:
- QR code didn't render properly
- Authenticator app camera permission not granted

**Solution**:
- Provide manual entry option (secret code)
- Verify camera permission in app settings
- Try different authenticator app
- Ensure sufficient lighting for QR code scanning

#### User locked out of account

**Cause**:
- 2FA device lost
- All backup codes used
- Authenticator app uninstalled

**Solution**:
- Implement account recovery email verification
- Send recovery link to registered email
- Allow 2FA bypass via recovery email for 24 hours
- Contact support for manual unlock

#### Time-based codes keep failing

**Cause**: Server time and authenticator app time are out of sync

**Solution**:
- Sync device time (Settings → Date & Time)
- Check server time is correct (NTP sync)
- Adjust TOTP_WINDOW_SIZE if needed (increase tolerance)
- User should enable automatic time sync

### Database Issues

#### OAuth profile not saved

**Cause**: Database connection issue or schema missing

**Solution**:
- Run migrations: `npm run migrate`
- Check database is running
- Verify DATABASE_URL is correct
- Check user table has oauth_providers column

#### Backup codes not being hashed

**Cause**: bcrypt library not installed or misconfigured

**Solution**:
- Install bcrypt: `npm install bcrypt`
- Check bcrypt installed correctly: `npm list bcrypt`
- Restart server

---

## API Reference

### OAuth Endpoints

#### GET /api/oauth/google/auth

Generate Google login URL

**Response:**
```json
{
  "authUrl": "https://accounts.google.com/o/oauth2/v2/auth?..."
}
```

#### POST /api/oauth/google/callback

Handle Google OAuth callback

**Request Body:**
```json
{
  "code": "authorization_code",
  "state": "csrf_state_parameter"
}
```

**Response:**
```json
{
  "accessToken": "jwt_token",
  "refreshToken": "refresh_token",
  "user": {
    "id": "user_id",
    "email": "user@example.com",
    "name": "User Name"
  }
}
```

#### GET /api/oauth/accounts

Get linked OAuth accounts (requires auth)

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "accounts": ["google", "github"]
}
```

#### POST /api/oauth/link

Link OAuth account to authenticated user

**Headers:**
```
Authorization: Bearer <token>
```

**Request Body:**
```json
{
  "code": "authorization_code",
  "provider": "google"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Account linked successfully"
}
```

### 2FA Endpoints

#### GET /api/2fa/setup

Generate QR code and backup codes

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "secret": "JBSWY3DPEBLW64TMMQ======",
  "qrCode": "data:image/png;base64,iVBOR...",
  "backupCodes": [
    "XXXX-XXXX",
    "XXXX-XXXX",
    ...
  ]
}
```

#### POST /api/2fa/enable

Enable 2FA after verification

**Headers:**
```
Authorization: Bearer <token>
```

**Request Body:**
```json
{
  "secret": "JBSWY3DPEBLW64TMMQ======",
  "token": "123456",
  "backupCodes": ["XXXX-XXXX", ...]
}
```

**Response:**
```json
{
  "success": true,
  "message": "2FA enabled successfully"
}
```

#### POST /api/2fa/verify

Verify TOTP token during login

**Request Body:**
```json
{
  "userId": "user_id",
  "token": "123456"
}
```

**Response:**
```json
{
  "valid": true,
  "accessToken": "jwt_token",
  "refreshToken": "refresh_token"
}
```

#### GET /api/2fa/status

Get 2FA status

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "enabled": true,
  "backupCodesRemaining": 8
}
```

---

## Next Steps

1. **Update Login Page**: Integrate OAuthPage components into main login flow
2. **Update Account Settings**: Add TwoFactorPage to account management UI
3. **Update API Client**: Add OAuth/2FA endpoints to TypeScript types
4. **Update Documentation**: Add user guides for OAuth login and 2FA setup
5. **Monitor**: Set up alerts for OAuth/2FA related errors
6. **Compliance**: Ensure GDPR/CCPA compliance for OAuth data handling

